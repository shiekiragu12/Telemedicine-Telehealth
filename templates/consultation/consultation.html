<style>
    .chat-msg {
        background: white;
        padding: 10px;
        max-width: 70%;
        margin-bottom: 10px;
    }

    .content-holder{
        --assist-height: 90vh;
        height: var(--assist-height);
        overflow: auto;
    }

    .custom-assist-card {
        --assist-height: 90vh;
        --header-size: 60px;
        border-radius: 20px;
        /* padding: 20px; */
        background-color: rgba(0, 0, 255, 0.144);
        height: var(--assist-height);
    }

    .assist-header {
        height: var(--header-size);
    }

    .assist-footer {
        height: var(--header-size);
    }

    .assist-body {
        height: calc(var(--assist-height) - (var(--header-size) * 2));
        overflow-y: scroll;
        padding: 10px;
        border-bottom: 1px solid #ccc;
        border-top: 1px solid #ccc;
    }

    .assist-body::-webkit-scrollbar {
        width: 6px;
    }

    .assist-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .assist-body::-webkit-scrollbar-track {
        background: #fff;
        border-radius: 10px;
        box-shadow: inset 7px 10px 12px #f0f0f0;
    }

    .assist-body p {
        /* color: #131419 !important; */
        /* white-space: pre-wrap; */
        padding: 5px 10px;
    }

    .me {
        /* background: blue;
        color: white !important; */
        background-color: #93acff;
        color: #333;
    }

    .other {
        background-color: #F2F2F2;
        color: #333;
    }

    .my-avatar {
        width: var(--size);
        height: var(--size);
        border-radius: 50%;
        display: block;
        background: whitesmoke;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        text-transform: capitalize;
        font-size: 32px;
        font-weight: 600;
    }

    .my-avatar img {
        max-width: 100%;
        width: 100%;
        height: 100%;
    }

    .chat-container {
        position: fixed;
        height: 100vh;
        width: 100vw;
        top: 0;
        left: 50%;
        transform: translate(-50%);
        background: white;
        z-index: 10000;
    }

    @media screen and (max-width: 768px) {
        .chat-container{
            height: auto;
            min-height: 100vh;
            overflow: auto;
        }
    }

    .hide-btn{
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 2;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">

<div id="my_user_id" data-my_user_id="{{request.user.id}}"></div>
<div id="appointment" data-appointment_id="{{appointment.id}}"></div>

<div class="chat-container hide">
    <div class="container-fluid position-relative">
        <button class="btn btn-primary hide-btn" onclick="hideChat()">
            Hide Chat
        </button>
        <div class="row">
            <div class="col-md-4 order-2 order-md-1 d-none d-md-block">
                <div class="content-holder">
                {% if appointment.doctor.id == request.user.doctor.id %}
                {% include './../doctor-dashboard/components/appointment-info-for-doctor.html' with include_chat=False %}
                {% endif %}
                {% if appointment.patient.id == request.user.patient.id %}
                {% include './../patient-dashboard/components/appointment-info-for-patient.html' with include_chat=False %}
                {% endif %}
            </div>
            </div>
            <div class="col-md-6 order-1 order-md-2">
                <div class="card border-0 custom-assist-card">
                    <div class="assist-header d-flex align-items-center justify-content-center">
                        <p class="text-center w-100">
                            Text consultation with
                            {% if appointment.patient.user.id == request.user.id %}
                            Dr. {{appointment.doctor.user.get_full_name}}
                            {% else %}
                            patient {{appointment.patient.user.get_full_name}}
                            {% endif %}
                        </p>
                    </div>
                    <div class="assist-body">
                        <div class="msgs-holder" id="msgs-holder">
                            {% for msg in appointment.chatmessage_set.all %}
                            {% if msg.sender.id == request.user.id %}
                            {% include './my_message.html' with message=msg %}
                            {% else %}
                            {% include './other_user_message.html' with message=msg %}
                            {% endif %}
                            {% endfor %}
                            <!-- <div class="chat-msg gpt">
                            <p>
                                Hi, I am your virtual assistant. I will help you to check your symptoms.
                            </p>
                        </div>
                        <div class="chat-msg person">
                            <p>
                                I am having a headache.
                            </p>
                        </div> -->
                        </div>
                    </div>
                    <div class="assist-footer d-flex align-items-center justify-content-center">
                        <div class="w-100">
                            <form id="chat-form" autocomplete="off">
                                <div class="form-group mb-0">
                                    <div class="input-group input-group-m" style="border-radius: 10px;">
                                        <div class="input-group-text">
                                            <i class="fa fa-message"></i>
                                        </div>
                                        <input type="text" autocomplete="off" class="form-control shadow-none "
                                            id="text" placeholder="Type message" name="text" style="border-radius: 10px;">
                                        <div class="input-group-text p-0">
                                            <button class="btn px-3 py-2 shadow-none"><i
                                                    class="fa fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script type="module">
    import { writeToFirebase, listenOnFirebaseMessages } from '/static/assets/js/firebase.js';
    listenOnFirebaseMessages(printNewMessageToChat)

    const APPOINTMENT_ID = parseInt(document.getElementById('appointment').dataset.appointment_id)
    const MY_USER_ID = parseInt(document.getElementById('my_user_id').dataset.my_user_id)
    console.log(APPOINTMENT_ID, MY_USER_ID)
    // function scrollToBottom(el) {
    //     const element = document.getElementById(el);
    //     if (element) {
    //         setTimeout(() => {
    //             lastChild?.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
    //             element.scrollTo({
    //                 top: element?.scrollHeight,
    //                 behavior: "smooth",
    //                 block: "end"
    //             });
    //             console.log("ereach")
    //             element.scrollTop = element.scrollHeight
    //         }, 10);
    //     }
    // }

    function enableDisableBodyScroll(enable = true) {
        if (enable) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }

    }

    function scrollToBottom() {
        const msgsHolder = document.querySelector('.msgs-holder');
        let body = document.querySelector('body');
        const children = msgsHolder.children;
        const lastChild = children[children.length - 1];
        if (lastChild) {
            setTimeout(() => {
                body.style.overflow = 'hidden !important'
                // lastChild?.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
                msgsHolder.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" })
            }, 100);
            body.style.overflow = 'auto !important'
        }
    }

    $('#chat-form').on('submit', (e) => {
        e.preventDefault()
        const text = $('#text').val()
        if (text === "" || text === null || text === undefined) {
            toastr.error("Text Message required")
            return
        }
        else {
            postMessage()
        }
    })

    function postMessage() {
        const loc = window.location
        const url = `${loc.protocol}//${loc.host}/api/interact/messages/chat-group/`

        const formdata = new FormData(document.querySelector('#chat-form'))
        formdata.append('appointment', APPOINTMENT_ID)
        formdata.append('sender', MY_USER_ID)

        const headers = {
            'X-CSRFToken': getCookie('csrftoken')
        }

        axios.post(url, formdata, { headers }).then((response) => {
            const data = response.data;
            document.getElementById('chat-form').reset();
            // printNewMessageToChat(data)
            // window.location.reload()
            writeToFirebase(data)
        }).catch((error) => {
            console.log(error)
            toastr.error(`Error - ${error.message}`)
        });
    }

    function printMessagesToChat(messages) {
        const my_id = parseInt(document.querySelector('#my_user_id').dataset.my_user_id)
        let msg_str = ""
        let i;
        for (i = 0; i < messages.length; i++) {
            const msg = messages[i]
            if (msg.sender.id === my_id) {
                msg_str += renderMyMessage(msg)
            }
            else {
                msg_str += renderOtherMessage(msg)
            }
        }
        $('#messages').html(msg_str)
        scrollToBottom('messages')
        // initializeGlight()
    }

    function printNewMessageToChat(obj, group = false) {
        console.log("real time message: ", obj)
        if (obj) {
            const message = obj
            if (message !== null && message !== undefined && message !== '' && message?.appointment === APPOINTMENT_ID) {
                let msg_str = ""
                if (message?.sender?.id === MY_USER_ID) {
                    msg_str += renderMyMessage(message, group)
                }
                else {
                    msg_str += renderOtherMessage(message, group)
                }
                const messages = document.querySelector('#msgs-holder')
                messages.insertAdjacentHTML('beforeend', msg_str)
                scrollToBottom(messages)
            }
        }
        // initializeGlight()
    }

    function renderOtherMessage(message) {
        let images = ""
        for (let i = 0; i < message?.files?.length; i++) {
            let file = message?.files[i]
            images += `<a href="${file.file}" target="_blank" class="glightbox"><img src="${file.file}" class="chat-image" /></a>`
        }
        let avatar = ""
        if (message?.sender?.profile?.profile_photo) {
            avatar = `<img src="${message?.sender?.profile?.profile_photo}" alt="${message?.sender?.first_name} ${message?.sender?.last_name}" />`
        }
        else {
            avatar = message?.sender?.username[0]
        }

        return `
            <div class="d-flex flex-row justify-content-start">
                <div class="my-avatar" style="--size: 50px">
                    ${avatar}
                </div>
                <div style="width: 70%">
                    <div class="d-flex w-100 flex-wrap gap-2 align-items-center justify-content-start mb-1 position-relative ps-4">
                        ${images}
                    </div>
                    <p class="small p-2 ms-3 mb-1 rounded-3 other">
                        ${message?.text}
                    </p>
                    <div class="d-flex justify-content-between me-3 mb-2">
                        <p class="small rounded-3 text-muted p-0 m-0">${message?.created_on}</p>
                    </div>
                </div>
            </div>
        `
    }

    function renderMyMessage(message) {
        let images = ""
        for (let i = 0; i < message?.files?.length; i++) {
            let file = message?.files[i]
            images += `<a href="${file.file}" target="_blank" class="glightbox"><img src="${file.file}" class="chat-image" /></a>`
        }
        let avatar = ""
        if (message?.sender?.profile?.profile_photo) {
            avatar = `<img src="${message?.sender?.profile?.profile_photo}" alt="${message?.sender?.first_name} ${message?.sender?.last_name}" />`
        }
        else {
            avatar = message?.sender?.username[0]
        }

        return `
            <div class="d-flex flex-row justify-content-end">
                <div style="width: 70%">
                    <div class="d-flex w-100 flex-wrap gap-2 align-items-center justify-content-end mb-1 position-relative pe-4">
                        ${images}
                    </div>
                    <p class="small p-2 me-3 mb-1 rounded-3 me">
                        ${message?.text}
                    </p>
                    <div class="d-flex justify-content-between  me-3 mb-2 ">
                        <p class="small rounded-3 text-muted p-0 m-0">${message?.created_on}</p>
                    </div>
                </div>
                <div class="my-avatar" style="--size: 50px">
                    ${avatar}
                </div>
            </div>
        `
    }

</script>