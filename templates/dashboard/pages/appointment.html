{% extends './../components/base.html' %}
{% load static %}

{% block styles %}
<!-- Pick date -->
<link rel="stylesheet" href="{% static 'dashboard/vendor/pickadate/themes/default.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/vendor/pickadate/themes/default.date.css' %}">
<!-- Clockpicker -->
<link href="{% static 'dashboard/vendor/clockpicker/css/bootstrap-clockpicker.min.css' %}" rel="stylesheet">

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="content-body">
	<!-- row -->
	<div class="container-fluid">
		<div class="text-end mb-3">
			<a href="javascript:void(0);" class="btn btn-primary btn-rounded add-appointment">+ Book Appointment</a>
			<a href="{% url 'doctors' facility_id=1 %}" class="btn btn-primary btn-rounded">Doctor Schedule</a>
		</div>
		<div class="row">
			<div class="col-xl-12">
				<div class="card">
					<div class="card-body">
						<div class="table-responsive">
							<table id="example5" class="table table-striped patient-list mb-4 dataTablesCard fs-14">
								<thead>
									<tr>
										<th>
											<div class="checkbox text-end align-self-center">
												<div class="form-check custom-checkbox ">
													<input type="checkbox" class="form-check-input" id="checkAll"
														required="">
													<label class="form-check-label" for="checkAll"></label>
												</div>
											</div>
										</th>
										<th>Name</th>
										<th>Email</th>
										<th>Date Of Appointment</th>
										<th>From</th>
										<th>To</th>
										<th>Mobile</th>
										<th>Consulting Doctor</th>
										<th>Injury/Condition</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									{% for app in appointments %}
									<tr>
										<td>
											<div class="checkbox text-end align-self-center">
												<div class="form-check custom-checkbox ">
													<input type="checkbox" class="form-check-input" id="customCheckBox1"
														required="">
													<label class="form-check-label" for="customCheckBox1"></label>
												</div>
											</div>
										</td>
										<td class="patient-info ps-0">
											<span>
												<img src="{% if app.patient.user.profile.profile_photo %}{{app.patient.user.profile.profile_photo.url}} {% endif %}"
													alt="">
											</span>
											<span class="text-nowrap ms-2">{{app.patient.user.first_name}}
												{{app.patient.user.last_name}}</span>
										</td>
										<td class="text-primary">{{app.patient.user.email}}</td>
										<td>{{app.date}}</td>
										<td>{{app.start_time}}</td>
										<td>{{app.end_time}}</td>
										<td class="text-primary">{{app.patient.user.profile.phone_number}}</td>
										<td>Dr. {{app.doctor.user.first_name}} {{app.doctor.user.last_name}}</td>
										<td>{{app.condition.name}}</td>
										<td>
											<span class="me-3">
												<a href="javascript:void(0);" class="edit-appointment"><i
														class="fa fa-pencil fs-18 " aria-hidden="true"></i></a>
											</span>
											<span>
												<i class="fa fa-trash fs-18" aria-hidden="true"></i>
											</span>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="appointment-edit-form" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Edit Appointment</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					</button>
				</div>
				<div class="modal-body">
					<form>
						<div class="row">
							<div class="col-xl-12">
								<div class="form-group">
									<label for="recipient-name" class="col-form-label">Title:</label>
									<select class="form-control">
										<option>Miss</option>
										<option>Mr.</option>
										<option>Mrs.</option>
									</select>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Name:</label>
									<input type="text" class="form-control" id="" placeholder="Name">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Last Name:</label>
									<input type="text" class="form-control" id="" placeholder="Last Name">
								</div>
							</div>
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Date Of Appointment:</label>
									<input size="16" type="date" value="13-9-2021" class="form-control">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">From:</label>
									<input size="16" type="time" value="12:00" class="form-control">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">To:</label>
									<input size="16" type="time" value="12:00" class="form-control">
								</div>
							</div>
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Address :</label>
									<textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Mobile No:</label>
									<input type="text" class="form-control" id="" placeholder="Mobile">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Email Id:</label>
									<input type="email" class="form-control" id="" placeholder="Email">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Consulting Doctor:</label>
									<select class="form-control">
										<option>Dr.HANI B BARADI</option>
										<option>Dr.NAJJIA N MAHMOUD</option>
										<option>Dr. SANKAR NAIDU ADUSUMILLI</option>
									</select>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Injury/Condition:</label>
									<input type="text" class="form-control" id="" placeholder="fever">
								</div>
							</div>
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Note:</label>
									<textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
								</div>
							</div>
						</div>


					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary">Send message</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="appointment-add-form" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Book Appointment</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
					</button>
				</div>
				<div class="modal-body">
					<form id="appointment-form" action="{% url 'appointments_create' request.facility.id %}"
						method="post">
						{% csrf_token %}
						<input type="text" class="form-control d-none" id="facility_id" value="{{request.facility.id}}"
							placeholder="Facility Id">
						<div class="row form-material">
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Patient</label>
									<select class="form-control" name="patient" id="patient-select">
										<option value="">Select patient</option>
										{% for patient in patients %}
										<option value="{{patient.id}}">
											{{patient.user.first_name}}
											{{patient.user.last_name}} - {{patient.user.profile.phone_number}}
										</option>
										{% endfor %}
									</select>
								</div>
							</div>
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Date of Appointment:</label>
									<input type="date" class="form-control" id="date" name="date">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label class="col-form-label">From</label>
									<input type="text" class="form-control" id="start_time" name="start_time"
										placeholder="Starting time">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label class="col-form-label">To</label>
									<input type="text" class="form-control" id="end_time" name="end_time"
										placeholder="End time">
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Consulting Doctor:</label>
									<select class="form-control" name="doctor" required>
										{% for doctor in doctors %}
										<option value="{{doctor.id}}">
											Dr. {{doctor.user.first_name}} {{doctor.user.last_name}}
										</option>
										{% endfor %}
									</select>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Injury/Condition</label>
									<select class="form-control" name="condition" required>
										{% for cond in conditions %}
										<option value="{{cond.id}}">{{cond.name}}</option>
										{% endfor %}
									</select>
								</div>
							</div>
							<div class="col-xl-12">
								<div class="form-group">
									<label for="message-text" class="col-form-label">Note:</label>
									<textarea class="form-control" id="exampleFormControlTextarea1" rows="3"
										name="note"></textarea>
								</div>
							</div>
						</div>

						<div class="row col-md-8 offset-md-2 text-center">
							<div id="msgSubmit" class="py-2"></div>
							<div id="msgSubmitErrors" class="py-2"></div>
						</div>

					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="submit" form="appointment-form" class="btn btn-primary">Make Appointment</button>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<!-- pickdate -->
<script src="{% static 'dashboard/vendor/pickadate/picker.js' %}"></script>
<script src="{% static 'dashboard/vendor/pickadate/picker.time.js' %}"></script>
<script src="{% static 'dashboard/vendor/pickadate/picker.date.js' %}"></script>
<!-- clockpicker -->
<script src="{% static 'dashboard/vendor/clockpicker/js/bootstrap-clockpicker.min.js' %}"></script>

<script>
	// Date picker
	// $('#date').pickadate({
	// 	format:'y.m.d'
	// });

	// Time picker
	$('#start_time').pickatime(
		{
			min: [8, 30],
			max: [16, 0],
			interval: 15,
		}
	)

	$('#end_time').pickatime(
		{
			min: [8, 30],
			max: [16, 0],
			interval: 15,
		}
	)



	$(document).on('click', '.edit-appointment', function () {
		$('#appointment-edit-form').modal('show');
	});
	$(document).on('click', '.add-appointment', function () {
		$('#appointment-add-form').modal('show');
	});
	(function ($) {

		var table = $('#example5').DataTable({
			searching: false,
			paging: true,
			select: false,
			//info: false,         
			lengthChange: false

		});
		// $('#example tbody').on('click', 'tr', function () {
		// 	var data = table.row(this).data();

		// });

	})(jQuery);

	// jQuery('#mdate').datetimepicker({
	// 	datepicker: true,
	// 	// format: 'H:i'
	// });
</script>
<script>

	const spinner = () => {
		return `
			<div class="d-flex align-items-center justify-content-center flex-column">
				<div class="spinner-border ml-auto mb-2" role="status" aria-hidden="true"></div>
				<strong>Loading...</strong>
			</div>
		`
	}

	$("#appointment-form").on("submit", e => {
		e.preventDefault()
		postAppointment()
	})

	const postAppointment = () => {
		const loc = window.location
		const url = `${loc.protocol}//${loc.host}/api/appointments/`

		const formdata = new FormData(document.getElementById("appointment-form"))
		formdata.append('facility', $("#appointment-form #facility_id").val())
		toastr.options = {
			positionClass: "toast-bottom-center",
			progressBar: true,
			timeOut: 10000
		}
		const headers = {
			'X-CSRFToken': getCookie('csrftoken')
		}

		$("#msgSubmitErrors").html("")
		$("#msgSubmit").html(spinner)
		axios.post(url, formdata, { headers }).then((response) => {
			const data = response.data;
			toastr.info('Appointment Created Successfully')
			$("#msgSubmit").html(`<div class="alert alert-success">Appointment Created Successfully. On the next page refresh you can be able to see the newly created doctor.</div>`)
		}).catch((error) => {
			console.log(error.response.data)
			toastr.error(`Error - ${error.message}`)
			$("#msgSubmit").html(`<div class="alert alert-danger">${error.message}</div>`)
			if (typeof error?.response?.data === 'object') {
				const stringified_error = JSON.stringify(error.response.data, null, 4)
				const highlight_HTML = hljs.highlight(stringified_error, { language: 'json' }).value
				const header = `<h4>Errors</h4>`
				$("#msgSubmitErrors").html(`${header}<pre><code class="hljs rounded">${highlight_HTML}</code></pre>`)
			}
		});
	};

</script>
{% endblock %}