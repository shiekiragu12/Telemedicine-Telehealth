{% load static %}

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    {% for msg in messages %}
    {% if msg.tags == "error" %}
    <div id="liveToast" class="toast bg-danger text-white mb-2 border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="toast-header">
            <!-- <img src="..." class="rounded me-2" alt="..."> -->
            <i class="fa fa-bell me-2"></i>
            <strong class="me-auto">Alert</strong>
            <!-- <small>11 mins ago</small> -->
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            {{msg | safe}}
        </div>
    </div>
    {% else %}
    <div id="liveToast" class="toast bg-{{msg.tags}} text-white border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="toast-header">
            <!-- <img src="..." class="rounded me-2" alt="..."> -->
            <i class="fa fa-bell me-2"></i>
            <strong class="me-auto">Alert</strong>
            <!-- <small>11 mins ago</small> -->
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body form-errors">
            {{msg | safe}}
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Information modal -->

<div class="modal fade" id="info-modal" tabindex="-1" aria-labelledby="info-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="info-modal-title">
                    <!-- Title goes here -->
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Content goes here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Javascripts -->
<script src="{% static 'superadmin/assets/plugins/jquery/jquery-3.5.1.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/bootstrap/js/popper.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/perfectscroll/perfect-scrollbar.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/pace/pace.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/datatables/datatables.min.js' %}"></script>
<script src="{% static 'superadmin/assets/plugins/highlight/highlight.pack.js' %}"></script>
<script src="{% static 'superadmin/assets/js/main.min.js' %}"></script>
<script src="{% static 'superadmin/assets/js/custom.js' %}"></script>
<!-- Toastr js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<!-- <script src="{% static 'superadmin/assets/js/pages/dashboard.js' %}"></script> -->
 
<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Hightlight JS -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

<!-- Select 2 JS -->
<script src="{% static 'superadmin/assets/plugins/select2/js/select2.full.min.js' %}"></script>

<script>
    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip()
    })
    $(document).ready(function () {
        $('.toast').each(function () {
            var toast = $(this);
            var delay = toast.data('delay') || 5000; // set default delay to 5 seconds
            var autohide = toast.data('autohide') || true; // set default autohide to true
            var animation = toast.data('animation') || true; // set default animation to true
            toast.toast({
                delay: delay,
                autohide: autohide,
                animation: animation
            });
            toast.toast('show');
        });
    });
</script>

<script>
    const infoModal = document.getElementById('info-modal')
    infoModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const title = button.getAttribute('data-bs-title')
        const content = button.getAttribute('data-bs-content')

        // Update the modal's content
        infoModal.querySelector('.modal-title').textContent = title
        infoModal.querySelector('.modal-body').innerHTML = content

    })
</script>

<script>
    // Function to get site cookie for cross site forgery protection.
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function spinner() {
        return `
			<div class="d-flex align-items-center justify-content-center flex-column">
				<div class="spinner-border ml-auto mb-2" role="status" aria-hidden="true"></div>
				<strong>Loading...</strong>
			</div>
		`
    }

    function postEntry(endpoint, form_id, extra_fields = []) {
        const loc = window.location
        const url = `${loc.protocol}//${loc.host}/${endpoint}`

        const formdata = new FormData(document.getElementById(form_id))
        for (let i = 0; i < extra_fields.length; i++) {
            formdata.append(extra_fields[i]['field'], extra_fields[i]['value'])
        }
        toastr.options = {
            positionClass: "toast-bottom-center",
            progressBar: true,
            timeOut: 10000
        }
        const headers = {
            'X-CSRFToken': getCookie('csrftoken')
        }

        $(`#${form_id} .msgSubmitErrors`).html("")
        $(`#${form_id} .msgSubmit`).html(spinner())

        axios.post(url, formdata, { headers }).then((response) => {
            const data = response.data;
            toastr.info('Entry Created Successfully')
            $(`#${form_id} .msgSubmit`).html(`<div class="alert alert-success">Entry Created Successfully.</div>`)
        }).catch((error) => {

            toastr.error(`Error - ${error.message}`)
            $(`#${form_id} .msgSubmit`).html(`<div class="alert alert-danger">${error.message}</div>`)
            if (typeof error?.response?.data === 'object') {
                const stringified_error = JSON.stringify(error.response.data, null, 4)
                const highlight_HTML = hljs.highlight(stringified_error, { language: 'json' }).value
                const header = `<h4>Errors</h4>`
                $(`#${form_id} .msgSubmitErrors`).html(`${header}<pre><code class="hljs rounded">${highlight_HTML}</code></pre>`)
            }
        });
    };


    function updateEntry(endpoint, form_id, extra_fields = []) {
        const loc = window.location
        const url = `${loc.protocol}//${loc.host}/${endpoint}`

        const formdata = new FormData(document.getElementById(form_id))
        for (let i = 0; i < extra_fields.length; i++) {
            formdata.append(extra_fields[i]['field'], extra_fields[i]['value'])
        }
        toastr.options = {
            positionClass: "toast-bottom-center",
            progressBar: true,
            timeOut: 10000
        }
        const headers = {
            'X-CSRFToken': getCookie('csrftoken')
        }

        $(`#${form_id} .msgSubmitErrors`).html("")
        $(`#${form_id} .msgSubmit`).html(spinner())

        axios.put(url, formdata, { headers }).then((response) => {
            const data = response.data;
            toastr.info('Entry Updated Successfully')
            window.location.reload()
            $(`#${form_id} .msgSubmit`).html(`<div class="alert alert-success">Entry Updated Successfully.</div>`)
        }).catch((error) => {

            toastr.error(`Error - ${error.message}`)
            $(`#${form_id} .msgSubmit`).html(`<div class="alert alert-danger">${error.message}</div>`)
            if (typeof error?.response?.data === 'object') {
                const stringified_error = JSON.stringify(error.response.data, null, 4)
                const highlight_HTML = hljs.highlight(stringified_error, { language: 'json' }).value
                const header = `<h4>Errors</h4>`
                $(`#${form_id} .msgSubmitErrors`).html(`${header}<pre><code class="hljs rounded">${highlight_HTML}</code></pre>`)
            }
        });
    };


    function deleteEntry(endpoint) {

        toastr.options = {
            positionClass: "toast-bottom-center",
            progressBar: true,
            timeOut: 10000
        }

        const headers = {
            'X-CSRFToken': getCookie('csrftoken')
        }

        const loc = window.location
        const url = `${loc.protocol}//${loc.host}/${endpoint}`

        let text = "Are you sure you want to delete the entry?\nClick OK to confirm or Cancel to discurd.";
        if (confirm(text) == true) {
            axios.delete(url, { headers }).then((response) => {
                const data = response.data;
                toastr.info('Entry Deleted Successfully')
                window.location.reload()
            }).catch((error) => {
                console.log(error)
                toastr.error(`Error - ${error.message}`)
            });
        }
    }

    function updateReadStatus(endpoint){

        const loc = window.location
        const url = `${loc.protocol}//${loc.host}${endpoint}`

        const headers = {
            'X-CSRFToken': getCookie('csrftoken')
        }

        axios.put(url, {read: true}, { headers }).then((response) => {
            const data = response.data;
            toastr.info('Message Marked as Read Successfully')
        }).catch((error) => {
            console.log(error)
            toastr.error(`Error - ${error.message}`)
        });
    }

</script>
